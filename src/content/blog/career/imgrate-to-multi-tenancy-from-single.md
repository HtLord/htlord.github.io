---
title: 轉移至多租借 - 系統架構
pubDate: '2024-01-13'
tags:
  - career
---

Story
---
隨著客戶的數量增加，需要使用到的雲端資源用量，以及不使所花費的時間，直線上升。
在這樣的狀況下，光是營運就在高負載，長期下來是不健康的狀態。又尤其是，當產品內容
，不會隨著客戶的不同，而有不同的功能，在這情況下，更沒有理由，讓各自擁有獨立的伺服器。
用量的增加與減少，可藉由一些自動化調度的工具管理，比方說 k8s 或其他 serverless 的服務。

Pros
---
- 降低營運成本，相類似的功能，被重複的利用
- 降低維護成本，當降低了各自服務的獨特性，可以減低部署的負擔

Cons
---
- 系統安全，跟資料保護，需要特別注意，不能被放在同個租區的使用者存取
- 系統的客戶特徵，需要利用其他方式表述
- 可能受到法規以及合約限制
- 相同群組的使用者，資源是共享的，需要特別注意用量平衡度
- 建置群組的分類，跟監測的機制
- 資料庫連線增加，記憶體用量，與連線管理的問題
- 資源自動調度建立

How-To
---
難易度取決於當前產品的成熟度，以及目前套用的 framework，當前專案使用的是
spring framework，而在此之下，他有好有壞。

先針對技術面，談談大致上需要先行建立的步驟
1. 確保伺服器是 stateless (e.g. caches 會造成一些問題)
2. 建立自動調度的機制
3. 建立監測機制
4. 開始實作 multi-tenancy

進入實作階段，根據專案使用，spring framework 的方便與不便之處。
Pros
- 有現成的工具，比方說 Hikari 可以協助你處理 connection pool的部分
- Spring framework 在某些版本之後，可以輕鬆地增添 datasource routing 的邏輯

Cons
- 耦合 spring framework，需要找到對應的文件，survey 跟 demo 實作端的時間會需要較長的時間
- 能使用的方式受到限制，因為所有工具基本上都與 spring framework 耦合
- 要看當前版本是否有支援，否則還要在維護一份機制，不一定吻合機會成本
- 如果有套用 security 之下，需要特別注意 thread context 的問題
  (a.k.a multi-thread 下，個個 thread 的狀態)

相反的，如果是在其他系統，如果你用 nodeJs，pool connection 相對有簡單的方法管理，若為 stateless，又
更沒有 multi-thread，那會輕鬆很多。